다중 선형 회귀분석
- 회귀분석이란
- 단순선형회귀분석
- 회귀계수 추정 : 최소자승법
- 회귀계수 의미 : 회귀계수의 해석
- 회귀계수 검정(선형회귀의 정확도 평가)

### 회귀분석이란?

입력 변수 X에 대해서 연속형 출력 변수 Y를 예측하는 것을 말한다.

회귀분석의 종류에는 

![](/assets/images/회귀모형 종류.JPG)

<u>X가 여러개(Multiple)</u> 이면서 <u>선형(Linear)</u>인 **다중 선형 회귀분석**에 대해 알아보자.

## 다중 선형 회귀분석

- 목적 : 종속변수 Y와 설명변수 집합 X1, X2, ... , Xp 사이의 관계를 선형으로 가정하고 이를 가장 잘 설명할 수 있는 회귀계수를 추정

<img src = "./image/다중선형회귀/회귀모형 식.JPG" width="50%">

$y$ : 정답(관측된 값)

$\hat{y}$ : 예측(모델에 의해 추정된 값)

그런데 위의 관계식을 보면 설명할 수 없는 **노이즈($\epsilon$)**가 존재한다. 

노이즈는 데이터를 생성 및 수집하는 과정에서 발생할 수 있는 여러 원인들에 의해 생기는 변동성이다.

이러한 노이즈는 회귀모형에 필연적으로 존재하는 것이기 때문에 우리는 이러한 노이즈를 감안한 채로 **$y$와 가장 유사한 $\hat{y}$을 만들어야 한다.**

## 회귀계수 추정

$\hat{y}$ 식에서의 미지수(파라미터)는 $\hat{\beta}$(선형회귀계수)이기 때문에 이 회귀계수를 찾는 것이 다중선형회귀분석의 목적이라고 할 수 있다.

어떤 회귀계수? $\Rightarrow$
**$y$와 $\hat{y}$을 가장 유사하게 만드는 회귀계수**

즉, **$y$ - $\hat{y}$이 최소가 되는 회귀계수!**


그런데 생각해보면 당연히 <u>실제 값($y$)</u>과 <u>우리가 추정한 값($\hat{y}$)</u>의 차이는 적을수록 좋다.

<img src = "./image/다중선형회귀/잔차.JPG" width="40%">
<center> [잔차] </center>

이 차이를 **잔차(residual)**라고 한다.

$e_i = y -\hat{y}$

그런데 이러한 잔차는 부호를 가지기 때문에 잔차의 합으로 하면 상쇄되는 값들이 생겨 차이를 볼 수 없다.

$\Rightarrow$ **<u>잔차의 제곱합</u>을 최소화하는 방향으로 회귀계수를 추정** : **<u>최소자승법</u>(Ordinary least square : OLS)**

- 잔차의 제곱합 : SSE(;Error Sum of Squares)
    - $SSE = \sum_{i=1}^{n}e_i^2 = e_1^2 + e_2^2 + \cdots + e_n^2$

- 최소자승법
    - $min \sum_{i=1}^{n} (y_i - \hat{y_i})^2$

Q. 잔차의 부호를 제거하는 방법으로 제곱합을 사용하는 이유는?

A. 잔차의 제곱합은 미분이 가능한 형태로 유일한 해를 찾을 수 있기 때문이다.(절대값의 합은 미분이 불가능한 형태)


#### 회귀계수를 추정해보자.
<img src = "./image/다중선형회귀/회귀계수 추정(행렬).JPG" width="70%">

**회귀계수 $\beta$는 학습데이터에 대해 유일하고 명시적인 해(solution)가 존재한다!**

$\beta = (X'X)^{-1}X'y$

문제점 : $X$들 간의 상관관계가 크면 역행렬이 구해지지 않을 수 있다 $\rightarrow$ $\beta$의 의미 x

## 회귀계수 검정

잔차를 최소화하는 방향으로 구한 회귀계수가 과연 회귀식에서 통계적으로 유의한지 

즉, y를 예측하는데 도움이 되는지 확인해야 한다.

그리고 이를 통해 해당 변수의 설명력을 믿어도 되는지 파악할 수 있다.

회귀계수 하나 하나의 검정을 통해 각 변수의 설명력을 살펴보는 것이다.

$\hat{\beta_p}$의 검정
- 귀무가설 : $\beta_p = 0$ (회귀계수는 0이다. 즉 변수의 설명력이 없다.) $\Rightarrow$ 기각하고 싶은 가설
- 대립가설 : $\beta_p = 0$ (회귀계수는 0이 아니다. 즉 변수의 설명력이 존재한다.) $\Rightarrow$ 채택하고 싶은 가설
- t검정을 통해서 검정
    - $t = \frac{\hat{B_p}}{\frac{S}{\sqrt{S_{xx}}}} = \frac{\hat{B_p}}{s.e(\hat{B_p})}$

<img src = "./image/다중선형회귀/회귀계수 검정.JPG" width="60%">

- Coefficient : 회귀계수
- Std.error : 회귀계수의 표준오차
- t_statistic : 회귀계수의 유의성을 판단하는 통계치 $\rightarrow$ 보통 3 이상이면 p-value가 거의 0에 수렴한다.
- p-value : 유의확률 $\rightarrow$ 유의수준(보통 0.05)을 설정하여 유의수준보다 작을 경우 귀무가설 기각

표를 보고 회귀계수를 해석해보면

- TV 광고 예산(x)이 1 증가하면 매출(y)은 0.046단위 만큼 증가한다. 
- radio 광고 예산(x)이 1 증가하면 매출(y)은 0.189단위 만큼 증가한다. 
- 두 경우 모두 유의성은 매우 높다.(귀무가설 기각)(y를 예측하는데 도움이 된다.)
- 반면 newspaper는 p-value가 너무 높아서 귀무가설을 채택하게 된다. 즉 y를 예측하는데 도움이 되지 않는 변수이다.

## 회귀모형의 정확도 평가
- 추정된 모형이 얼마나 정확한지 평가

**종속변수의 전체 변동성(분산) = 회귀식이 설명할 수 있는 변동성 + 회귀식이 설명할 수 없는 변동성**
<img src = "./image/다중선형회귀/SST=SSR+SSE.JPG" width="60%">   
- SST : 종속변수 전체 변동성 - 정해져 있다.
- SSR : 회귀식이 설명할 수 있는 변동성
- SSE : 회귀식이 설명할 수 없는 변동성


$R^2$, 결정계수 = 전체 변동성 중 회귀식이 설명할 수 있는 변동성의 비율
<img src = "./image/다중선형회귀/r2식.JPG" width="40%">   
    
- $R^2 = 0$ $\rightarrow$ 추정된 회귀직선이 X와 Y의 관계를 전혀 설명하지 못함
- $R^2 = 1$ $\rightarrow$ 추정된 회귀직선으로 Y의 총변동이 완전히 설명됨
- $R^2$이 1에 가까울 수록 선형회귀 모형의 설명력이 높다는 것을 뜻한다.

## 모델 검정

앞서 각 회귀계수의 유의성을 검정했다면 이번에는 전체 모델의 유의성을 검정해보자.

다중 선형 회귀분석은 여러 개의 설명변수로 회귀식이 이루어져 있기 때문에 모델 검정을 통해 모든 회귀계수에 대한 검정을 할 수 있다.

- 귀무가설 : $\beta_1 = \beta_2 ... \beta_p = 0$ (모든 회귀계수는 0이다. 즉 변수의 설명력이 하나도 존재하지 않는다.)
- 대립가설 : 하나의 회귀계수라도 0이 아니다. (즉 설명력이 있는 변수가 존재한다.)
- F검정을 통해서 검정
    - $F = \frac{V_1/k_1}{V_2/k_2} \sim F(k_1,k_2)$
    - 두 확률변수 V1, V2가 서로 독립인 카이제곱 분포를 따른다고 할 때 확률변수 F는 F분포를 따른다. F검정과 분산분석 등에서 주로 사용됨.
    
<img src = "./image/다중선형회귀/모델검정1.JPG" width="60%">

**위 대립가설은 기각하기 너무 쉬운 가설이다. 변수가 추가되면 추가될 수록 기각하기 쉬워진다.**
- F-Statistics = $\frac{MSR}{MSE}$
    - 변수가 추가되면 MSR이 커지고, MSE는 작아진다. 
    - $\Rightarrow$ F통계량 커짐(제곱합의 형태니까) 
    - $\Rightarrow$ p-value 작아진다.
    
<img src = "./image/다중선형회귀/모델검정2.JPG" width="70%">

$\Rightarrow$ 변수의 수가 많을 때 $R^2$ 와 F검정의 결과가 큰 의미를 가지지 않을 수 있다.(무조건 신뢰 x)

## 성능평가

그런데 이러한 과정을 거쳐서 **학습데이터에 대해서 100% 정확한 모델을 만들면 좋은 것일까?**

No! 모델이 학습데이터에 존재하는 노이즈까지 외우게 되어 새로운 데이터에 적용할 경우 예측 성능이 저하되는 과적합(Overfiting) 현상이 발생할 수 있다.

과적합(Overfiting) : 학습데이터에 대한 성능은 좋지만, 이 모델을 통해 실제로 확인하고 싶은 새로운 데이터에 대해서는 성능이 좋지 않은 경우

**$\Rightarrow$ 데이터 분할을 통해 성능평가 수행**

#### 1. 데이터 분할

<img src = "./image/다중선형회귀/데이터분할.JPG" width="40%">

- training : 학습 데이터 $\rightarrow$ 실제로 모델을 만들 때 사용하는 데이터
- validation : 검증 데이터 $\rightarrow$ 학습 데이터를 통해 만든 모델을 검증(ex.과적합)
- test : 테스트 데이터 $\rightarrow$ 실제로 모델을 적용 한다는 가정이어야 한다.

시간정보를 고려할 필요가 없는 경우
- 무작위 추출(Random Sampling) 방식으로 학습:검증:테스트 데이터셋으로 분할
- 비율의 정답은 없으나 검증 및 테스트셋의 데이터가 충분히 확보될 수 있는 범위 내에서 6:2:2부터 8:1:1까지 분할 가능하다.
- 한 번 추출된 데이터셋으로 비교 대상인 모든 후보 모델(알고리즘)에 일괄 적용해야 한다.

시간정보를 고려해야 하는 경우
- 반드시 학습:검증:테스트는 시간 순서대로 배열이 되어 있어야 한다.
- 무작위 추출 방식을 사용할 경우 미래 정보를 활용하여 과거를 예측하는 오류를 범할 수 있다.

#### 2. 성능평가
1. $R^2$
    - 결정계수 = 전체 변동성 중 회귀식이 설명할 수 있는 변동성의 비율
    - 변수가 증가할수록 자연스레 증가(유의하지 않은 변수가 추가되어도 항상 증가)
    - 0 $\leq$ $R^2$ $\leq$ 1 : 클수록 좋음


2. $Adjusted R^2$
    - $R^2$의 단점을 보완해주는 지표
    - $R^2$에 변수의 수만큼 penalty를 준다.
    - 유의하지 않은 변수가 추가될 경우 증가하지 않는다.
<img src = "./image/다중선형회귀/adjusted R2.JPG" width="40%">

3. MAE (Mean Absolute Error)
    - 평균절대오차
    - 실제값과 예측값 사이의 절대적인 오차의 평균을 측정한 것이다.
    - 지표 자체가 직관적이며 예측변수와 단위가 같다.
    - 절대적인 차이가 중요한 분야에서 사용됨 (예. 추천시스템의 평점 예측)
    - 단점 : 상대적인 차이에 대한 정보를 제공하지 못한더,
<img src = "./image/다중선형회귀/mae.JPG" width="30%">

4. MAPE (Mean Absolute Percentage Error)
    - 실제값 대비 얼마나 예측 차이가 있는지를 비율(%)로 측정
    - 상대적인 오차율이 절대적인 오차 수치보다 중요한 분야에서 자주 사용된다. (예. 제조업에서의 품질지표 관리)
    - 0에 가까울수록 성능이 좋다고 해석한다.
<img src = "./image/다중선형회귀/mape.JPG" width="30%">

5. MSE, RMSE
    - 실제값과 예측값 사이의 오차의 제곱의 평균을 측정(MSE 단점 : 예측변수와 단위가 다르다.)
    - 부호의 영향을 제거하기 위해 절대값이 아닌 제곱(제곱합의 제곱근)을 취한 지표
    - 잔차를 제곱하기 때문에 이상치에 민감하다.
    - 작을수록 좋지만, 과도하게 줄이면 과적합의 오류를 범할 가능성이 있다. $\rightarrow$ 검증데이터의 MSE를 줄이는 방향으로!
<img src = "./image/다중선형회귀/mse, rmse.JPG" width="60%">

(참고용)

6. AIC (Akaike information criterion)
    - MSE에 변수 수만큼 penalty를 주는 지표
<img src = "./image/다중선형회귀/aic.JPG" width="30%">

7. BIC (Bayes information criterion)
    - AIC의 단점을 보완한 지표 (AIC:표본 n이 커질 때 부정확해짐)
    - 큰 차이는 없다.
<img src = "./image/다중선형회귀/bic.JPG" width="30%">
